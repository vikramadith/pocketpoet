<!DOCTYPE html>
<html>
<head>
<title>Page Title</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="css/jquery.mobile-1.4.3.css" />
<link rel="stylesheet" href="css/main.css" />
<script src="js/jquery-1.11.1.js"></script>
<script src="js/jquery.mobile.custom.min.js"></script>
<script>
	$(function() 
	{
		$("[data-role='navbar']").navbar();
		$("[data-role='header'], [data-role='footer']").toolbar();
		$("#nav1").hide();
	});

	$(document).on("pagecontainershow", function() 
	{
		ScaleContentToDevice();
	});
	
	var currentPage = "#home";

	function onNav(location) 
	{
		if(location == "#home")
		{
			$.mobile.changePage(location, {transition: "slideup"});	
			$("#nav1").hide();
			$("#nav2").show();			
		}
		else
		{
			$.mobile.changePage(location, {transition: "slidedown"});	
			$("#nav2").hide();
			$("#nav1").show();
		}
		
		currentPage = location;
	}

	function ScaleContentToDevice() 
	{
		scroll(0, 0);
		var content = $.mobile.getScreenHeight()
				- $(".ui-header").outerHeight() - $(".ui-footer").outerHeight()
				- $(".ui-content").outerHeight() + $(".ui-content").height();
		$(".ui-content").height(content);
		
	}
	
	function clearClick()
	{
		switch(currentPage)
		{
			case "#rhyme":
				$("#rhymeTI").val("");
				break;

			case "#meaning":
				$("#meaningTI").val("");
				break;

			case "#syllables":
				$("#syllablesTI").val("");
				break;

			case "#scansion":
				scansion = "";
				$("#scansionTxt").text("--");
				break;
		}
	}
	
	function clearAllClick()
	{
		$("#rhymeTI").val("");
		$("#meaningTI").val("");
		$("#syllablesTI").val("");
		scansion = "";
		$("#scansionTxt").text("--");
		
		words = [];
		
		displayWords();
	}
	
	var scansion = "";

	function scansionControlClick(event)
	{
		var scansionCtrl = $(event.target).parent()[0].id;
		
		$("#" + scansionCtrl).css("border-color", "#3388CC");
		
		setTimeout(function()
				{
					$("#" + scansionCtrl).css("border-color", "rgba(255, 255, 255, 0)");					
				}, 200);
		
		if(scansionCtrl == "scansionAddUnstressed")
		{
			scansion += "*";
		}
		else
		{
			scansion += "<span class='scansionTextS'>/</span>";
		}
		
		$("#scansionTxt").html(scansion);
	}
	
	function doneClick()
	{
		onNav("#home");
	}	

	var isSearchingRhyme = false;
	var isSearchingMeaning = false;
	var isSearchingSyllables = false;
	var isSearchingScansion = false;
	var words = [];
	
	function searchClick()
	{
		words = [];
		
		checkFields();
		
		if(isSearchingRhyme)
		{
			fetchRhymes();
		}
		else
		{
			fetchRhymesComplete();
		}
	}
	
	function checkFields()
	{
		isSearchingRhyme = false;
		isSearchingMeaning = false;
		isSearchingSyllables = false;
		isSearchingScansion = false;
		
		if($("#rhymeTI").val().length > 0)
		{
			isSearchingRhyme = true;
		}
		if($("#meaningTI").val().length > 0)
		{
			isSearchingMeaning = true;
		}
		if($("#syllablesTI").val().length > 0)
		{
			isSearchingSyllables = true;
		}
		if($("#scansionTxt").text() != "--")
		{
			isSearchingScansion = true;
		}
	}
	
	function fetchRhymes()
	{
		console.log("http://rhymebrain.com/talk?function=getRhymes&word=" + $("#rhymeTI").val());
		
		$.ajax(
				{
					url: "http://rhymebrain.com/talk?function=getRhymes&word=" + $("#rhymeTI").val()
				})
				.done(fetchRhymesHandler);
	}
	
	function fetchRhymesHandler(data)
	{
		console.log(data);
		
		for(var dataIndex = 0; dataIndex < data.length; dataIndex++)
		{
			console.log("Rhyme score: " + data[dataIndex].score);
			if(data[dataIndex].score < 200)
			{
				console.log("Nope rhyme score: " + data[dataIndex].score)
				continue;
			}
			if(isSearchingSyllables)
			{
				if(data[dataIndex].syllables != $("#syllablesTI").val())
				{
					continue;
				}
			}
			
			console.log("Rhyme push: " + data[dataIndex].word);
			
			words.push(data[dataIndex].word);
		}
		
		fetchRhymesComplete();
	}
	
	function fetchRhymesComplete()
	{
		if(isSearchingMeaning)
		{
			fetchSynonyms();
		}
		else
		{
			fetchSynonymsComplete();
		}
	}
	
	function fetchSynonyms()
	{
		console.log("http://www.stands4.com/services/v2/syno.php?uid=3460&tokenid=kJ2gkdLBvKBR7Qww&word=" + $("#meaningTI").val());
		
		$.ajax(
				{
					url: "http://www.stands4.com/services/v2/syno.php?uid=3460&tokenid=kJ2gkdLBvKBR7Qww&word=" + $("#meaningTI").val()
				})
				.done(fetchSynonymsHandler);
	}
	
	function fetchSynonymsHandler(xml)
	{
		console.log(xml);
		
		var synonyms = [];
		
		$(xml).find("result").each(function()
			{
				var synonymsNodeTxt = $(this).find("synonyms").text();
				
				var itemArray = synonymsNodeTxt.split(", ");
				
				for(var itemIndex = 0; itemIndex < itemArray.length; itemIndex++)
				{
					var item = itemArray[itemIndex];
					
					var isItemInList = false;
					for(var synonymsIndex = 0; synonymsIndex < synonyms.length; synonymsIndex++)
					{
						if(item == synonyms[synonymsIndex])
						{
							isItemInList = true;
							break;
						}
					}
					
					if(!isItemInList)
					{
						console.log("Syn init push: " + item);
						synonyms.push(item);
					}
				}
			});
		
		if(!isSearchingRhyme)
		{
			words = synonyms;
		}
		else
		{
			var matchingWords = [];
			
			for(var synonymsIndex = 0; synonymsIndex < synonyms.length; synonymsIndex++)
			{
				var synonym = synonyms[synonymsIndex];
												
				for(var wordIndex = 0; wordIndex < words.length; wordIndex++)
				{
					if(synonym == words[wordIndex])
					{
						console.log("Syn match push: " + synonym);
						
						matchingWords.push(synonym);
						break;
					}
				}
			}
			
			words = matchingWords;
		}	
		
		fetchSynonymsComplete();
	}
	
	function fetchSynonymsComplete()
	{
		if(isSearchingScansion || (isSearchingSyllables && !isSearchingRhyme))
		{
			checkWordDetails();
		}
		else
		{
			displayWords();
		}
	}
	
	var matchingWordsDetail = [];
	var wordDetailIndex = 0;
	
	function checkWordDetails()
	{
		matchingWordsDetail = [];
		wordDetailIndex = 0;
		
		fetchWordDetails();
	}
	
	function fetchWordDetails()
	{
		console.log(wordDetailIndex + "http://rhymebrain.com/talk?function=getWordInfo&word=" + words[wordDetailIndex])
		
		$.getJSON("http://rhymebrain.com/talk?function=getWordInfo&word=" + words[wordDetailIndex], fetchDetailsHandler);
	}
	
	function fetchDetailsHandler(data)
	{
		var isMatching = true;
		
		if(isSearchingSyllables && !isSearchingRhyme)
		{
			if(data.syllables !=  $("#syllablesTI").val())
			{
				console.log("Nope Syll: " + data.word);
				isMatching = false;
			}
		}
		
		if(isSearchingScansion)
		{
			if(data.word.indexOf(" ") >= 0)
			{
				console.log("Nope Scan Space: " + data.word);
				isMatching = false;
			}
			else
			{
				if(!isScansionMatching(data.pron))
				{
					console.log("Nope Scan: " + data.word);
					isMatching = false;				
				}
			}
		}
		
		if(isMatching)
		{
			console.log("Push matching detail: " + words[wordDetailIndex]);
			matchingWordsDetail.push(words[wordDetailIndex]);
		}
		
		if(++wordDetailIndex == words.length)
		{
			checkWordDetailsComplete();
		}
		else
		{
			fetchWordDetails();				
		}
	}
	
	function testClick()
	{
		var t1 = "Boo";
		var t2 = "Boo oo";
		
		if(t1.indexOf(" ") >= 0)
		{
			console.log("Nope1");
		}
		if(t2.indexOf(" ") >= 0)
		{
			console.log("Nope3");
		}
	}
	
	function isScansionMatching(pron)
	{
		//var pron = "HH AH0 L OW1";
		
		var pronScansion = "";
		
		for(var charIndex = 0; charIndex < pron.length; charIndex++)
		{
			switch(pron[charIndex])
			{
				case "0":
				case "2":
					pronScansion += "*";
					break;
					
				case "1":
					pronScansion += "/";
					break;
			}
		}
		
		console.log(pron + ": " + pronScansion);
		
		var pronFieldScansion = $("#scansionTxt").text();
		
		if(pronScansion.length < pronFieldScansion.length)
		{
			console.log("Pron: false shorter");
			return false;
		}
		
		pronScansionReverse = pronScansion.split("").reverse().join("");
		pronFieldScansionReverse = pronFieldScansion.split("").reverse().join("");
		
		var isMatching = true;
		for(var charIndex = 0; charIndex < pronFieldScansionReverse.length; charIndex++)
		{
			if(pronFieldScansionReverse[charIndex] != pronScansionReverse[charIndex])
			{
				isMatching = false;
				break;
			}
		}

		console.log("Pron: " + isMatching);
		return isMatching;
	}
	
	function checkWordDetailsComplete()
	{
		console.log(matchingWordsDetail);
		
		words = matchingWordsDetail;
		
		console.log(words);
		
		displayWords();
	}
	
	function displayWords()
	{
		console.log("Display words");
		
		var listHTML = "";
		
		for(var wordIndex = 0; wordIndex < words.length; wordIndex++)
		{
			listHTML += "<li>" + words[wordIndex] + "</li>";
		}		

		$("#wordList").html(listHTML);
		$("#wordList").listview("refresh");
	}
	
</script>

</head>

<body>

	<div data-role="header" data-position="fixed" data-theme="a"
		class="headz" data-tap-toggle="false">
		<div class="headzTxt">Pocket Poet</div>
		<div data-role="navbar">
			<ul>
				<li>
					<div class="filterBox filterBoxRhyme" onclick="onNav('#rhyme');">Rhyme</div>
				</li>
				<li>
					<div class="filterBox filterBoxMeaning"
						onclick="onNav('#meaning');">Meaning</div>
				</li>
				<li>
					<div class="filterBox filterBoxSyllables"
						onclick="onNav('#syllables');">Syllables</div>
				</li>
				<li>
					<div class="filterBox filterBoxScansion"
						onclick="onNav('#scansion');">Scansion</div>
				</li>
			</ul>
		</div>
	</div>

	<div data-role="page" id="home" data-title="Home" class="homePage">

		<div data-role="main" class="ui-content">
			<div class="fieldPage">
				<ul id="wordList" data-role="listview">
				</ul>
			</div>
		</div>
		<!-- /content -->

	</div>
	<!-- /page -->

	<div data-role="page" id="rhyme" data-title="rhyme" class="rhymePage">

		<div data-role="main" class="ui-content">
			<div class="fieldPage">
				<br /> <span class="fieldTitle">Word to rhyme with:</span> <input
					data-clear-btn="true" name="rhymeTI" id="rhymeTI" value=""
					type="text">

			</div>
		</div>
		<!-- /content -->

	</div>
	<!-- /page -->



	<div data-role="page" id="meaning" data-title="rhyme"
		class="meaningPage">

		<div data-role="main" class="ui-content">
			<div class="fieldPage">

				<br /> <span class="fieldTitle">Synonymous with:</span> <input
					name="meaningTI" id="meaningTI" value="" type="text">
			</div>
		</div>
		<!-- /content -->


	</div>
	<!-- /page -->

	<div data-role="page" id="syllables" data-title="Home"
		class="syllablesPage">

		<div data-role="main" class="ui-content">
			<div class="fieldPage">

				<br /> <span class="fieldTitle">Number of syllables:</span> <input
					name="syllablesTI" id="syllablesTI" value="" type="number">
			</div>
		</div>
		<!-- /content -->


	</div>
	<!-- /page -->

	<div data-role="page" id="scansion" data-title="rhyme"
		class="scansionPage">

		<div data-role="main" class="ui-content">
			<div class="fieldPage">

				<br /> <span class="fieldTitle">Ending stress pattern:</span> <br />
				<div id="scansionTxt" class="scansionText">--</div>
				<br />
				<br /> Tap below to add stressed or unstressed syllables
				<div class="scansionControls">
					<div id="scansionAddUnstressed" class="scansionGrid1"
						onclick="scansionControlClick(event);">
						<div class="scansionSymbol">*</div>
						<div class="scansionTxtBox">Unstressed</div>
					</div>
					<div id="scansionAddStressed" class="scansionGrid2"
						onclick="scansionControlClick(event);">
						<div class="scansionSymbolS">/</div>
						<div class="scansionTxtBoxS">Stressed</div>
					</div>
				</div>
			</div>
		</div>
		<!-- /content -->


	</div>
	<!-- /page -->

	<div data-role="footer" data-position="fixed" data-theme="b"
		data-tap-toggle="false">

		<!-- 		<div data-role="navbar" data-iconpos="left"> -->
		<!-- 			<ul id="fieldNav"> -->
		<!-- 				<li><a href="#" data-icon="delete"><span class="navBtn">Clear</span></a></li> -->
		<!-- 				<li><a href="#" data-icon="check" onclick="doneClick()"><span class="navBtn">Done</span></a></li> -->
		<!-- 			</ul> -->
		<!-- 			<ul id="mainNav"> -->
		<!-- 				<li><a href="#" data-icon="search" onclick="doneClick()"><span class="navBtn">Search</span></a></li> -->
		<!-- 			</ul> -->
		<!-- 		</div> -->

		<div id="nav1" data-role="navbar" data-iconpos="left">
			<ul>
				<li><a href="#" data-icon="delete" onclick="clearClick();"><span class="navBtn">Clear</span></a></li>
				<li><a href="#" data-icon="check" onclick="doneClick()"><span
						class="navBtn">Done</span></a></li>
			</ul>
		</div>

		<div id="nav2" data-role="navbar" data-iconpos="left">
			<ul>
				<li><a href="#" data-icon="delete" onclick="clearAllClick();"><span
						class="navBtn">Clear All</span></a></li>
				<li><a href="#" data-icon="search" onclick="searchClick();"><span
						class="navBtn">Search</span></a></li>
			</ul>
		</div>

	</div>

</body>
</html>